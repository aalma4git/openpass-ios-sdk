name: cocoapods-publish

on:
  workflow_dispatch:
    inputs:
        version:
          description: 'Tag name for release (e.g. "1.0.0")'
          required: true
          type: string

# https://github.com/actions/runner-images/?tab=readme-ov-file#available-images
jobs:
  publish:
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4

    - name: Set up
      run: mkdir tmp

    - name: Update podspecs
      run: |
        jq --arg VERSION "${{ inputs.version }}" '. | .version |= $VERSION | .source.tag |= $VERSION' OpenPass.podspec.json > tmp/OpenPass.podspec.json
        jq --arg VERSION "${{ inputs.version }}" '. | .version |= $VERSION | .source.tag |= $VERSION' OpenPassObjC.podspec.json > tmp/OpenPassObjC.podspec.json

    - name: Lint podspecs
      run: |
        pod spec lint tmp/OpenPass.podspec.json
        pod spec lint tmp/OpenPassObjC.podspec.json

    - name: Push podspecs to Cocoapods trunk
      env:
        COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      run: |
        pod trunk push tmp/OpenPass.podspec.json
        pod trunk push tmp/OpenPassObjC.podspec.json

    - name: Clean up
      run: rm -r tmp
